{"id":"reverse-engineering-granola-api-hvm","title":"Incorporate automatic initial token configuration by incorporating extract_tokens.py into main.py","description":"## Implementation Report: Integrating extract_tokens.py into main.py\n\n### Current State Analysis\n\n**extract_tokens.py:**\n- Reads from Granola's supabase.json at `~/Library/Application Support/Granola/supabase.json`\n- Extracts `refresh_token` from `workos_tokens.refresh_token`\n- Extracts `client_id` by parsing JWT access token payload (from `iss` field using regex)\n- Updates or creates `config.json` with these tokens\n\n**main.py:**\n- Calls `check_config_exists()` early (line 363)\n- Expects `config.json` to already exist with populated tokens\n- Does not attempt automatic token discovery\n- User must run `extract_tokens.py` manually before `main.py`\n\n### Recommended Integration Approach\n\n**Modify `check_config_exists()` function:**\n1. Check if config.json exists and is valid\n2. If missing or incomplete, attempt automatic extraction from supabase.json\n3. Provide clear feedback on results\n\n**Add new `auto_extract_tokens()` function:**\n- Encapsulate token extraction logic locally in main.py\n- Mirror extract_tokens.py logic exactly\n- Return (refresh_token, client_id) tuple or (None, None) on failure\n\n### Implementation Plan\n\n1. Add `auto_extract_tokens()` function to main.py (mirrors extract_tokens.py logic)\n2. Modify `check_config_exists()` to attempt auto-extraction when config missing\n3. If auto-extraction succeeds: save to config.json and continue\n4. If auto-extraction fails: show helpful error message with fallback instructions\n\n### Edge Cases\n- supabase.json not found → graceful error\n- workos_tokens missing → clear error  \n- JWT decoding fails → still return refresh_token if available\n- Existing valid config.json → use it (fast path, no extraction)\n\n### Benefits\n- Seamless UX: run `main.py` directly without intermediate step\n- No breaking changes: manual config.json still supported\n- extract_tokens.py remains useful for manual token updates/debugging","status":"closed","priority":2,"issue_type":"feature","owner":"larrykite@gmail.com","created_at":"2026-01-18T16:19:03.913973-06:00","created_by":"Larry Kite","updated_at":"2026-01-18T16:33:48.779048-06:00","closed_at":"2026-01-18T16:33:48.779048-06:00","close_reason":"Closed","comments":[{"id":1,"issue_id":"reverse-engineering-granola-api-hvm","author":"Larry Kite","text":"## Bug Fix: Always extract fresh tokens\n\nInitial implementation only extracted tokens when config.json was missing. This caused \"Session has already ended\" errors when the stored refresh_token was stale.\n\n**Fix**: Changed `check_config_exists()` to ALWAYS extract fresh tokens from `supabase.json` on every run, then update config.json. Falls back to existing config.json only if supabase.json extraction fails.","created_at":"2026-01-18T22:31:36Z"}]}
